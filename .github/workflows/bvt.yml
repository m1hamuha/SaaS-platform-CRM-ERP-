name: Build Verification Test (BVT)

on:
  # Run on push to main and develop branches
  push:
    branches: [ main, develop ]
  
  # Run on pull requests to main
  pull_request:
    branches: [ main ]
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Schedule daily runs at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

jobs:
  infrastructure-health-check:
    name: Infrastructure Health Check
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: crm_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
       - name: Install health check dependencies
        working-directory: ./scripts/health-check
        run: |
          npm init -y
          npm install pg ioredis
          npm install --save-dev @types/pg @types/ioredis
      
       - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres -d crm_erp_test; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          if ! pg_isready -h localhost -p 5432 -U postgres -d crm_erp_test; then
            echo "PostgreSQL failed to start"
            exit 1
          fi

       - name: Run infrastructure health checks
        working-directory: ./scripts/health-check
        run: node check-all.js
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: crm_erp_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          PGPASSWORD: postgres
      
      - name: Upload health check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-health-results
          path: |
            scripts/health-check/*.json
            scripts/health-check/*.log
          retention-days: 7

  backend-smoke-tests:
    name: Backend Smoke Tests
    runs-on: ubuntu-latest
    needs: infrastructure-health-check
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: crm_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run database migrations
        working-directory: ./backend
        run: |
          # Create test database schema
          npx typeorm-ts-node-commonjs migration:run -d src/database/data-source.ts
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_DATABASE: crm_erp_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-for-bvt
          NODE_ENV: test
      
      - name: Run backend smoke tests
        working-directory: ./backend
        run: npm test -- test/smoke --passWithNoTests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_DATABASE: crm_erp_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-for-bvt
          NODE_ENV: test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-smoke-test-results
          path: |
            backend/coverage/
            backend/test-results.xml
          retention-days: 7

  frontend-smoke-tests:
    name: Frontend Smoke Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run frontend smoke tests
        working-directory: ./frontend
        run: npm test -- test/smoke --passWithNoTests
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000/api
          NEXT_PUBLIC_APP_URL: http://localhost:3000
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-smoke-test-results
          path: |
            frontend/coverage/
            frontend/test-results.xml
          retention-days: 7

  bvt-summary:
    name: BVT Summary Report
    runs-on: ubuntu-latest
    needs: [infrastructure-health-check, backend-smoke-tests, frontend-smoke-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate BVT summary report
        run: |
          echo "# Build Verification Test Results" > bvt-summary.md
          echo "## Run: ${{ github.run_id }} (${{ github.run_number }})" >> bvt-summary.md
          echo "## Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> bvt-summary.md
          echo "" >> bvt-summary.md
          
          echo "### Job Status" >> bvt-summary.md
          echo "- Infrastructure Health Check: ${{ needs.infrastructure-health-check.result }}" >> bvt-summary.md
          echo "- Backend Smoke Tests: ${{ needs.backend-smoke-tests.result }}" >> bvt-summary.md
          echo "- Frontend Smoke Tests: ${{ needs.frontend-smoke-tests.result }}" >> bvt-summary.md
          echo "" >> bvt-summary.md
          
          echo "### Overall Status" >> bvt-summary.md
          if [[ "${{ needs.infrastructure-health-check.result }}" == "success" && \
                "${{ needs.backend-smoke-tests.result }}" == "success" && \
                "${{ needs.frontend-smoke-tests.result }}" == "success" ]]; then
            echo "✅ **ALL CHECKS PASSED** - System is ready for deployment" >> bvt-summary.md
          else
            echo "❌ **SOME CHECKS FAILED** - Review failed tests before deployment" >> bvt-summary.md
          fi
          
          echo "" >> bvt-summary.md
          echo "### Next Steps" >> bvt-summary.md
          echo "1. Review detailed test results in artifacts" >> bvt-summary.md
          echo "2. Fix any failing tests" >> bvt-summary.md
          echo "3. Re-run BVT before deployment" >> bvt-summary.md
      
      - name: Upload BVT summary
        uses: actions/upload-artifact@v4
        with:
          name: bvt-summary-report
          path: bvt-summary.md
          retention-days: 30
      
      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('bvt-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  notify-failure:
    name: Notify on BVT Failure
    runs-on: ubuntu-latest
    needs: [infrastructure-health-check, backend-smoke-tests, frontend-smoke-tests]
    if: failure() && contains(needs.*.result, 'failure')
    
    steps:
      - name: Send Slack notification
        if: env.SLACK_BOT_TOKEN != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: 'C12345678' # Replace with actual channel ID
          slack-message: |
            ❌ BVT Failed for ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_id }}
            Commit: ${{ github.sha }}
            Jobs:
              - Infrastructure: ${{ needs.infrastructure-health-check.result }}
              - Backend: ${{ needs.backend-smoke-tests.result }}
              - Frontend: ${{ needs.frontend-smoke-tests.result }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true

      - name: Create failure summary
        if: always()
        run: |
          echo "# BVT Failure Notification" > bvt-failure-summary.md
          echo "## Failed Jobs" >> bvt-failure-summary.md
          echo "- Infrastructure: ${{ needs.infrastructure-health-check.result }}" >> bvt-failure-summary.md
          echo "- Backend: ${{ needs.backend-smoke-tests.result }}" >> bvt-failure-summary.md
          echo "- Frontend: ${{ needs.frontend-smoke-tests.result }}" >> bvt-failure-summary.md
          echo "" >> bvt-failure-summary.md
          echo "## Workflow Details" >> bvt-failure-summary.md
          echo "- Repository: ${{ github.repository }}" >> bvt-failure-summary.md
          echo "- Workflow: ${{ github.workflow }}" >> bvt-failure-summary.md
          echo "- Run: ${{ github.run_id }}" >> bvt-failure-summary.md
          echo "- Commit: ${{ github.sha }}" >> bvt-failure-summary.md
          echo "- Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> bvt-failure-summary.md

      - name: Upload failure summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bvt-failure-summary
          path: bvt-failure-summary.md
          retention-days: 30